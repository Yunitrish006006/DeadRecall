# 🔧 模組打包問題修復指南

## ❌ 發現的問題

你的模組在開發環境中能正常運作，但打包後無法使用，原因是：

### 1. **缺少 Gson 依賴** ⭐ 主要問題
你的 `DiscordBridge.java` 使用了 `com.google.gson.JsonParser`，但：
- ❌ `build.gradle` 中沒有聲明 Gson 依賴
- ❌ Gson 沒有被打包進模組 JAR 中
- 結果：打包後運行時會拋出 `ClassNotFoundException` 或 `NoClassDefFoundError`

### 2. **客戶端 Mixin 配置未註冊**
- `fabric.mod.json` 中只註冊了 `deadrecall.mixins.json`
- 缺少 `deadrecall.client.mixins.json` 的註冊

---

## ✅ 已修復的內容

### 修復 1: 添加 Gson 依賴
**檔案**: `build.gradle`

```groovy
dependencies {
    // ...existing dependencies...
    
    // Gson for JSON parsing (used in DiscordBridge)
    implementation 'com.google.code.gson:gson:2.10.1'
    include 'com.google.code.gson:gson:2.10.1'  // ⭐ 重要：將 Gson 打包進模組
}
```

**解釋**:
- `implementation`: 編譯時使用 Gson
- `include`: **將 Gson 打包進最終的 JAR 文件**（這是關鍵！）

### 修復 2: 註冊客戶端 Mixin
**檔案**: `src/main/resources/fabric.mod.json`

```json
"mixins": [
  "deadrecall.mixins.json",
  "deadrecall.client.mixins.json"
],
```

---

## 🚀 重新打包步驟

### 1. 清理舊的構建文件
```powershell
.\gradlew.bat clean
```

### 2. 重新構建模組
```powershell
.\gradlew.bat build
```

### 3. 找到生成的 JAR 文件
構建完成後，JAR 文件位於：
```
build/libs/deadrecall-1.1.0.jar
```

### 4. 驗證 Gson 已打包
解壓 JAR 檢查是否包含 Gson：
```powershell
# 臨時解壓查看
Expand-Archive -Path "build\libs\deadrecall-1.1.0.jar" -DestinationPath "temp_check" -Force

# 檢查是否有 com/google/gson 目錄
Test-Path "temp_check\com\google\gson"

# 清理
Remove-Item "temp_check" -Recurse -Force
```

應該返回 `True`，表示 Gson 已正確打包。

---

## 🧪 測試步驟

### 方法 1: 在生產環境測試（推薦）

1. **關閉開發環境的遊戲**

2. **複製 JAR 到 Minecraft mods 資料夾**
   ```powershell
   # 假設你的 Minecraft 資料夾是 .minecraft
   Copy-Item "build\libs\deadrecall-1.1.0.jar" -Destination "$env:APPDATA\.minecraft\mods\" -Force
   ```

3. **啟動 Minecraft**
   - 使用 Fabric Loader
   - 檢查模組列表中是否有 DeadRecall

4. **測試功能**
   - 創建或加入世界
   - 發送聊天訊息，檢查是否能轉發到 Discord
   - 測試 `/back` 指令

5. **檢查日誌**
   ```powershell
   # Minecraft 日誌位置
   Get-Content "$env:APPDATA\.minecraft\logs\latest.log" | Select-String "DeadRecall"
   ```

### 方法 2: 使用開發環境的 runClient 任務

```powershell
.\gradlew.bat runClient
```

但這會使用開發環境的類路徑，可能無法發現打包問題。

---

## 🔍 常見問題排查

### 問題 1: 模組無法加載

**症狀**: Minecraft 啟動但模組列表中沒有 DeadRecall

**檢查**:
1. 確認使用 Fabric Loader（不是 Forge）
2. 確認 Minecraft 版本是 1.21.1
3. 確認 Fabric API 已安裝

**日誌關鍵字**:
```
[FabricLoader] Loading mod deadrecall
```

### 問題 2: ClassNotFoundException

**症狀**: 日誌中出現：
```
java.lang.ClassNotFoundException: com.google.gson.JsonParser
```

**原因**: Gson 沒有正確打包

**解決**: 確認 `build.gradle` 中有 `include 'com.google.code.gson:gson:2.10.1'`

### 問題 3: Discord Bridge 無法初始化

**症狀**: 日誌中出現：
```
[DeadRecall] [DiscordBridge] 讀取設定檔失敗
```

**原因**: 配置文件問題或 Gson 解析錯誤

**檢查**:
```powershell
Get-Content "$env:APPDATA\.minecraft\config\discord-bridge.json"
```

確認 JSON 格式正確。

### 問題 4: Mixin 無法應用

**症狀**: 死亡座標記錄不工作

**檢查日誌**:
```
[mixin] Mixing ServerPlayerEntityMixin
```

**解決**: 確認 `fabric.mod.json` 中有註冊所有 mixin 配置文件。

---

## 📋 打包檢查清單

在發布模組前，確認以下項目：

- [ ] ✅ `build.gradle` 中添加了 Gson 依賴和 `include`
- [ ] ✅ `fabric.mod.json` 中註冊了所有 mixin 文件
- [ ] ✅ 執行 `.\gradlew.bat clean build` 重新構建
- [ ] ✅ 驗證 JAR 中包含 Gson 類
- [ ] ✅ 在生產環境（非開發環境）測試
- [ ] ✅ 測試所有功能：聊天轉發、/back 指令、死亡座標
- [ ] ✅ 檢查日誌沒有錯誤

---

## 🎯 為什麼開發環境能用但打包後不能用？

### 開發環境
- Gradle 自動將所有依賴添加到類路徑
- 包括 Gson（來自 Minecraft/Fabric 的傳遞依賴或 IDE 的依賴管理）
- 所有類都可用

### 打包後的環境
- JAR 文件是獨立的
- 只包含你模組的代碼
- **不包含依賴** - 除非你使用 `include`
- Minecraft/Fabric 不會自動提供 Gson（它們使用自己的內部版本）

### 解決方案
使用 `include` 將依賴打包進 JAR：
```groovy
include 'com.google.code.gson:gson:2.10.1'
```

這會將 Gson 的 class 文件複製到你的 JAR 中，使其成為 "fat JAR" 或 "uber JAR"。

---

## 📦 JAR 文件結構對比

### ❌ 修復前（缺少 Gson）
```
deadrecall-1.1.0.jar
├── com/adaptor/deadrecall/
│   ├── DiscordBridge.class  ← 使用 JsonParser 但找不到！
│   ├── Deadrecall.class
│   └── ...
├── fabric.mod.json
└── ...
```

### ✅ 修復後（包含 Gson）
```
deadrecall-1.1.0.jar
├── com/adaptor/deadrecall/
│   ├── DiscordBridge.class  ← 可以找到 JsonParser
│   ├── Deadrecall.class
│   └── ...
├── com/google/gson/          ← Gson 已打包！
│   ├── JsonParser.class
│   ├── JsonObject.class
│   └── ...
├── fabric.mod.json
└── ...
```

---

## 🎓 最佳實踐

### 1. 總是在生產環境測試
開發環境和打包環境不同，必須測試打包後的 JAR。

### 2. 使用 `include` 打包必要的庫
如果你的模組使用了非 Minecraft 標準庫，使用 `include` 打包它們。

### 3. 避免依賴衝突
- Gson 2.10.1 是相對新的版本，與大多數模組兼容
- 如果遇到衝突，可以使用 `jarJar` 進行重定位

### 4. 檢查 JAR 大小
- 修復前：~50KB
- 修復後：~300KB（包含 Gson）
- 如果異常大（>10MB），檢查是否誤打包了不必要的依賴

---

## 🚀 快速修復命令

```powershell
# 1. 清理
.\gradlew.bat clean

# 2. 重新構建
.\gradlew.bat build

# 3. 複製到 Minecraft
Copy-Item "build\libs\deadrecall-1.1.0.jar" -Destination "$env:APPDATA\.minecraft\mods\" -Force

# 4. 啟動並測試
# （手動啟動 Minecraft）
```

---

## ✅ 驗證修復成功

打包後的模組應該：
1. ✅ 在模組列表中顯示 "DeadRecall 1.1.0"
2. ✅ 日誌顯示 `[DeadRecall] [DiscordBridge] 已啟用` 或 `功能已停用`
3. ✅ 聊天訊息能轉發到 Discord（如果配置正確）
4. ✅ `/back` 指令可用
5. ✅ 死亡時記錄座標

---

**現在重新打包應該就能正常使用了！** 🎉
