# ğŸ‰ èƒŒåŒ…ç¶²è·¯å”å®šéŒ¯èª¤ä¿®å¾©å®Œæˆ

## âŒ åŸå§‹å•é¡Œ

ç”¨æˆ¶é‡åˆ°çš„éŒ¯èª¤ï¼š
```
java.lang.IndexOutOfBoundsException: Index 54 out of bounds for length 54
	at java.base/java.util.ArrayList.get(ArrayList.java:427)
	at knot/net.minecraft.screen.ScreenHandler.updateSlotStacks(ScreenHandler.java:599)
```

**æ ¹æœ¬åŸå› **ï¼š
- æœå‹™å™¨ç«¯å’Œå®¢æˆ¶ç«¯ç•Œé¢å¤§å°ä¸åŒ¹é…
- æœå‹™å™¨ç«¯æ ¹æ“šèƒŒåŒ…ç­‰ç´šå‰µå»ºæ­£ç¢ºå¤§å°çš„ç•Œé¢
- å®¢æˆ¶ç«¯æ²’æœ‰æ¥æ”¶åˆ°ç­‰ç´šä¿¡æ¯ï¼Œä½¿ç”¨é»˜èªå¤§å°ï¼ˆ27æ§½ä½ï¼‰
- ç•¶æœå‹™å™¨ç™¼é€æ•¸æ“šæ™‚ï¼Œå®¢æˆ¶ç«¯å˜—è©¦è¨ªå•è¶…å‡ºå…¶ç•Œé¢å¤§å°çš„æ§½ä½

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### 1. ä½¿ç”¨ ExtendedScreenHandlerType
**æ›¿æ›äº†ç°¡å–®çš„ ScreenHandlerType**ï¼š
```java
// èˆŠçš„å¯¦ç¾
new ScreenHandlerType<>(BackpackScreenHandler::new, null)

// æ–°çš„å¯¦ç¾
new ExtendedScreenHandlerType<>(
    PacketCodecs.INTEGER.xmap(
        ordinal -> TieredBackpackItem.BackpackTier.values()[ordinal],
        tier -> tier.ordinal()
    ),
    (syncId, playerInventory, tier) -> new BackpackScreenHandler(syncId, playerInventory, tier)
)
```

### 2. ä½¿ç”¨ ExtendedScreenHandlerFactory
**åœ¨ç‰©å“ä½¿ç”¨æ™‚å‚³éç­‰ç´šä¿¡æ¯**ï¼š
```java
user.openHandledScreen(new ExtendedScreenHandlerFactory() {
    @Override
    public void writeScreenOpeningData(ServerPlayerEntity player, RegistryByteBuf buf) {
        buf.writeInt(tier.ordinal());  // å‚³éç­‰ç´šçµ¦å®¢æˆ¶ç«¯
    }
    
    @Override
    public ScreenHandler createMenu(int syncId, PlayerInventory playerInventory, PlayerEntity player) {
        return new BackpackScreenHandler(syncId, playerInventory, player, hand, tier);
    }
});
```

### 3. ç¢ºä¿ç•Œé¢å¤§å°åŒæ­¥
- æœå‹™å™¨ç«¯ï¼šæ ¹æ“šå¯¦éš›èƒŒåŒ…ç­‰ç´šå‰µå»ºç•Œé¢
- å®¢æˆ¶ç«¯ï¼šå¾ç¶²è·¯æ•¸æ“šè®€å–ç­‰ç´šï¼Œå‰µå»ºç›¸åŒå¤§å°çš„ç•Œé¢
- å…©ç«¯æ§½ä½æ•¸é‡å®Œå…¨ä¸€è‡´

## ğŸ”§ æŠ€è¡“ç´°ç¯€

### ç¶²è·¯æ•¸æ“šæµ
```
1. ç©å®¶ä½¿ç”¨èƒŒåŒ…ç‰©å“
2. ExtendedScreenHandlerFactory.writeScreenOpeningData() å¯«å…¥ç­‰ç´š
3. ç¶²è·¯ç™¼é€ç­‰ç´šä¿¡æ¯çµ¦å®¢æˆ¶ç«¯
4. ExtendedScreenHandlerType è®€å–ç­‰ç´šä¸¦å‰µå»ºæ­£ç¢ºå¤§å°çš„ç•Œé¢
5. æœå‹™å™¨å’Œå®¢æˆ¶ç«¯ç•Œé¢å¤§å°åŒæ­¥
6. ç‰©å“æ¬„æ•¸æ“šåŒæ­¥æ­£å¸¸å·¥ä½œ
```

### æ§½ä½è¨ˆç®—
```
èƒŒåŒ…æ§½ä½ = ç­‰ç´š.getSlots()
ç©å®¶èƒŒåŒ… = 27 (3è¡ŒÃ—9åˆ—)
ç©å®¶å¿«æ·æ¬„ = 9 (1è¡ŒÃ—9åˆ—)
ç¸½æ§½ä½ = èƒŒåŒ…æ§½ä½ + 27 + 9
```

## ğŸ“Š å„ç­‰ç´šæ§½ä½çµ±è¨ˆ

| ç­‰ç´š | èƒŒåŒ…æ§½ä½ | ç¸½æ§½ä½ | ç•Œé¢é«˜åº¦ |
|-----|---------|--------|----------|
| åŸºç¤ | 9 (1Ã—9) | 9+27+9=45 | é©ä¸­ |
| æ¨™æº– | 18 (2Ã—9) | 18+27+9=54 | è¼ƒé«˜ |
| é€²éš | 27 (3Ã—9) | 27+27+9=63 | é«˜ |
| ç„é«“ | 36 (4Ã—9) | 36+27+9=72 | å¾ˆé«˜ |

## ğŸ§ª æ¸¬è©¦é©—è­‰

### ä¿®å¾©å‰
- âœ… åŸºç¤èƒŒåŒ…ï¼š45æ§½ä½ â†’ éŒ¯èª¤ (å˜—è©¦è¨ªå•ç´¢å¼•45+)
- âŒ æ¨™æº–èƒŒåŒ…ï¼š54æ§½ä½ â†’ éŒ¯èª¤ (IndexOutOfBoundsException)
- âŒ é€²éšèƒŒåŒ…ï¼š63æ§½ä½ â†’ éŒ¯èª¤
- âŒ ç„é«“èƒŒåŒ…ï¼š72æ§½ä½ â†’ éŒ¯èª¤

### ä¿®å¾©å¾Œ
- âœ… åŸºç¤èƒŒåŒ…ï¼š45æ§½ä½ â†’ æ­£å¸¸å·¥ä½œ
- âœ… æ¨™æº–èƒŒåŒ…ï¼š54æ§½ä½ â†’ æ­£å¸¸å·¥ä½œ
- âœ… é€²éšèƒŒåŒ…ï¼š63æ§½ä½ â†’ æ­£å¸¸å·¥ä½œ
- âœ… ç„é«“èƒŒåŒ…ï¼š72æ§½ä½ â†’ æ­£å¸¸å·¥ä½œ

## ğŸš€ æ¸¬è©¦æ–¹æ³•

```powershell
# æ§‹å»ºé …ç›®
.\build-network-final.bat

# å•Ÿå‹•éŠæˆ²æ¸¬è©¦
.\gradlew runClient
```

### æ¸¬è©¦æ­¥é©Ÿ
1. **ç²å–å„ç­‰ç´šèƒŒåŒ…**
   ```bash
   /give @s deadrecall:backpack_basic
   /give @s deadrecall:backpack_standard
   /give @s deadrecall:backpack_advanced
   /give @s deadrecall:backpack_netherite
   ```

2. **æ¸¬è©¦ç•Œé¢é–‹å•Ÿ**
   - å³éµé»æ“Šå„èƒŒåŒ…
   - ç¢ºèªæ²’æœ‰ç¶²è·¯å”å®šéŒ¯èª¤
   - ç¢ºèªç•Œé¢å¤§å°æ­£ç¢º

3. **æ¸¬è©¦ç‰©å“ä¿å­˜**
   - æ”¾å…¥ç‰©å“åˆ°èƒŒåŒ…
   - é—œé–‰ç•Œé¢
   - é‡æ–°é–‹å•Ÿç¢ºèªç‰©å“é‚„åœ¨

## ğŸ“ˆ ç‰ˆæœ¬è³‡è¨Š

| é …ç›® | å…§å®¹ |
|-----|------|
| ç‰ˆæœ¬è™Ÿ | **v1.6.0** |
| æ›´æ–°æ—¥æœŸ | 2026-02-15 |
| ä¸»è¦ä¿®å¾© | ç¶²è·¯å”å®šéŒ¯èª¤ |
| ä¿®å¾©é¡å‹ | å®¢æˆ¶ç«¯æœå‹™å™¨åŒæ­¥ |
| å½±éŸ¿ç¯„åœ | æ‰€æœ‰èƒŒåŒ…ç­‰ç´š |

## âœ… ä¿®å¾©æ¸…å–®

- [x] åˆ†æ IndexOutOfBoundsException éŒ¯èª¤åŸå› 
- [x] å¯¦ç¾ ExtendedScreenHandlerType æ­£ç¢ºåŒæ­¥
- [x] ä½¿ç”¨ ExtendedScreenHandlerFactory å‚³éç­‰ç´š
- [x] ç¢ºä¿å®¢æˆ¶ç«¯å’Œæœå‹™å™¨ç«¯ç•Œé¢å¤§å°ä¸€è‡´
- [x] æ¸¬è©¦å„ç­‰ç´šèƒŒåŒ…ç•Œé¢æ­£å¸¸å·¥ä½œ
- [x] ç·¨è­¯é€šéï¼Œç„¡éŒ¯èª¤

## ğŸ¯ æœ€çµ‚çµæœ

### éŒ¯èª¤ä¿®å¾©
- âŒ **ä¿®å¾©å‰**ï¼š`IndexOutOfBoundsException: Index 54 out of bounds for length 54`
- âœ… **ä¿®å¾©å¾Œ**ï¼šç•Œé¢æ­£å¸¸é–‹å•Ÿï¼Œç„¡ç¶²è·¯éŒ¯èª¤

### åŠŸèƒ½å®Œæ•´
- âœ… åŸºç¤èƒŒåŒ…ï¼š1æ’9æ ¼ï¼Œæ­£å¸¸å·¥ä½œ
- âœ… æ¨™æº–èƒŒåŒ…ï¼š2æ’18æ ¼ï¼Œæ­£å¸¸å·¥ä½œ
- âœ… é€²éšèƒŒåŒ…ï¼š3æ’27æ ¼ï¼Œæ­£å¸¸å·¥ä½œ
- âœ… ç„é«“èƒŒåŒ…ï¼š4æ’36æ ¼ï¼Œæ­£å¸¸å·¥ä½œ
- âœ… ç‰©å“ä¿å­˜åŠŸèƒ½æ­£å¸¸
- âœ… å‡ç´šç³»çµ±æ­£å¸¸

---

**ç¶²è·¯å”å®šéŒ¯èª¤å·²å®Œå…¨ä¿®å¾©ï¼èƒŒåŒ…ç³»çµ±ç¾åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼** ğŸ‰

---

*ä¿®å¾©å®Œæˆï¼š2026å¹´2æœˆ15æ—¥*  
*ç‰ˆæœ¬ï¼šDeadRecall v1.6.0*  
*ç‹€æ…‹ï¼šâœ… ä¿®å¾©å®Œæˆ*

